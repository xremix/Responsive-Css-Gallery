<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>JS Gallery</title>

	<!-- CSS -->
	<style type="text/css">
		body {
			text-align: center;
			background-color: darkgray;
		}

		.photo {
			float: left;
			background-color: gray; 
			display: inline-block;
		}

		.normal {
			width: 40px;
			height: 30px; 
		}

		.panorama {
			width: 160px;
			height: 90px; 
		}

		.portrait {
			width: 25px;
			height: 40px; 
		}

		.photos {
			width: 80%;
			margin:auto;
			background-color: gray;
		}
		/* TEST */
		img{
			-webkit-filter: brightness(1);
		}

	</style>
</head>
<body>
	<div class="photos">
		
<!-- 
		<div class="normal photo"></div>
		<div class="portrait photo"></div>
		<div class="panorama photo"></div>
		
		<div class="normal photo"></div>
		<div class="portrait photo"></div>
		<div class="panorama photo"></div>
		
		<div class="normal photo"></div>
		<div class="portrait photo"></div>
		<div class="portrait photo"></div>

		<div class="normal photo"></div>
		<div class="portrait photo"></div>
		<div class="panorama photo"></div>
		
		<div class="normal photo"></div>
		<div class="portrait photo"></div>
		<div class="panorama photo"></div>
		<div class="normal photo"></div>
		<div class="normal photo"></div>
		<div class="portrait photo"></div>
		<div class="panorama photo"></div>
		<div class="panorama photo"></div>
		<div class="panorama photo"></div>
		<div class="normal photo"></div>
		<div class="normal photo"></div>
		<div class="normal photo"></div>
		<div class="portrait photo"></div>
		<div class="normal photo"></div>
		<div class="normal photo"></div>
		<div class="normal photo"></div> -->



	</div>

	<!-- Scripts -->
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
	<script type="text/javascript">
	window.readyForGallerify = false;
	$(window).load(function() {
	    window.readyForGallerify = true;
	});
		$.fn.gallerify = function(params){
			var _this = this;// -1 pixel to make the resize look smooth

			function getImagesPerRow(screenWidth){
				console.log(screenWidth);
			 	if(screenWidth > 1200){
				    return 4;
				}
			    else if(screenWidth > 992){
				    return 3;
				}
			    else if(screenWidth > 768){
				    return 2;
				}else {
				    return 1;
				}
			}

			function resizeWidth(jChildren, rowWidth, margin){
				var currentWidth = _.reduce(jChildren, function(result, element){return result + element.width()}, 0);
				// -1 pixel to make the resize look smooth
				//Test adding 2px to the margin
				var factor =( rowWidth - 1 - (jChildren.length * (margin + 2) * 2)) / currentWidth;
			  	//var factor =( rowWidth - 1 - (jChildren.length * (margin) * 2)) / currentWidth;
				for (var i = 0; i < jChildren.length; i++) {
					
					jChildren[i].css('width', jChildren[i].width() * factor);
					var originalHeight = jChildren[i].height();
					if(jChildren[i].height() == originalHeight){
						// console.log("Height is equal");
						// jChildren[i].height(jChildren[i].height() * factor);
						// console.log("New " + jChildren[i].height() + " from " + originalHeight);
					}else{
						// console.log("Height is not equal");
						// jChildren[i].height(jChildren[i].height());
					}
					//jChildren[i].css('height', jChildren[i].height() * factor);
				};
			}

			function resizeHeight(jChildren, childHeight){
				for (var i = 0; i < jChildren.length; i++) {
					var factor =  childHeight / jChildren[i].height();
					var x = jChildren[i].width();
					var y = jChildren[i].height();

					jChildren[i].width(jChildren[i].width() * factor);

					var originalHeight = jChildren[i].height();
					if(jChildren[i].height() == originalHeight){
						// console.log("Height is equal");
						// jChildren[i].height(jChildren[i].height() * factor);
						// console.log("New " + jChildren[i].height() + " from " + originalHeight);
					}else{
						// console.log("Height is not equal");
						// jChildren[i].height(jChildren[i].height());
					}
					//jChildren[i].height(jChildren[i].height() * factor);
					// jChildren[i].height(jChildren[i].height());
				};
			}

			function renderRow(jChildren, galleryWidth, margin){
				var rowHeight = _.min(jChildren, function(t){return t.height() }).height();
				
				resizeHeight(jChildren, rowHeight);
				resizeWidth(jChildren, galleryWidth, margin);
			}

			function renderGallery(jGallery, _params){
				var jChildren = []; //jquery childs
				var jChildRows = []; //jquery childs
				var dChildren = jGallery.children(); //dom childs
				var width = _params.width ? _params.width : jGallery.width();
				imagesPerRow = _params.imagesPerRow ? _params.imagesPerRow : getImagesPerRow(width);
				console.log(_params);
				
				_params.margin =_params.margin ? _params.margin : 5;
				for (var i = 0; i < dChildren.length; i++) {
					var _jChild = $(dChildren[i]);
					if(_jChild.width() > 0){
						
						jChildren.push(_jChild);
						_jChild.css("margin", _params.margin);
						
						if(jChildren.length === imagesPerRow || i == dChildren.length -1){
							jChildRows.push(jChildren);
							renderRow(jChildRows[jChildRows.length - 1], width, _params.margin);
							jChildren = [];
						}
					}else{
						_jChild.load(function() {
						  	renderGallery(_this, params);
						    $( this ).addClass( "imgloaded" );
						});

					}
				};
			}

			function init(){
				console.log(window.readyForGallerify);
				if(window.readyForGallerify){
					renderGallery(_this, params);
				}else{
					$(window).on("load", function() {
						renderGallery(_this, params);
					});
				}
				
				$( window ).resize(function() {
					renderGallery(_this, params);
				});	
			}
			init();
			return _this;
		};
		// setTimeout(function(){
			$('.photos').gallerify({
				//margin:50
			});	
		// }, 2000);
		
	</script>
</body>
</html>