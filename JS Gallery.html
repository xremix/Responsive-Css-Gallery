<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>JS Gallery</title>

	<!-- CSS -->
	<style type="text/css">
		body {
			text-align: center;
			background-color: gray;
		}

		.photo {
			display: inline-block;
			width:auto;
			height:auto;
			position: relative;
		}
		.photo img{
			width: 100%;
		}
		.title{
			position: absolute;
			bottom:20px;
			left:0px;
			text-align: center;
			right:0px;
			font-size:2em;
			font-weight: bold;
			color:#979797;
		}
		.photos {
			margin:auto;
		}

	</style>
</head>
<body>
	<div class="photos">
		<div class="photo">
			<img src="http://placehold.it/400x900">
			<div class="title">10</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/400x900">
			<div class="title">10</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x900">
			<div class="title">10</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x400">
			<div class="title">1</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x400">
			<div class="title">2</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x400">
			<div class="title">3</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x400">
			<div class="title">4</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x400">
			<div class="title">5</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x320">
			<div class="title">6</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x400">
			<div class="title">7</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x400">
			<div class="title">8</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x900">
			<div class="title">9</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/900x600">
			<div class="title">10</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x400">
			<div class="title">11</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x280">
			<div class="title">12</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x400">
			<div class="title">13</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x900">
			<div class="title">14</div>
		</div>
		<div class="photo">
			<img src="http://placehold.it/600x400">
			<div class="title">15</div>
		</div> 
	</div>

	<!-- Scripts -->
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
	<script type="text/javascript">
		window.readyForGallerify = false;
		$(window).load(function() {
			window.readyForGallerify = true;
		});
		$.fn.gallerify = function(params){
			var _this = this;// -1 pixel to make the resize look smooth
			function getScreenSettings(galleryWidth){
				breakPoints = "bootstrap";
				var ret = {
					itemsPerColumn : -1,
					maxHeight : 500
				};

				//Items per column
				if(breakPoints = "bootstrap"){
				 	if(galleryWidth > 1200){
					    ret.itemsPerColumn = 4;
					}
				    else if(galleryWidth > 992){
					    ret.itemsPerColumn = 3;
					}
				    else if(galleryWidth > 768){
					    ret.itemsPerColumn = 2;
					}else {
					    ret.itemsPerColumn = 1;
					}
				}else if(breakPoints == "flickr"){
					if(galleryWidth > 1800){
						ret.itemsPerColumn = 4;
					}
					else if(galleryWidth > 1300){
						ret.itemsPerColumn = 3;
					}
					else if(galleryWidth > 610){
						ret.itemsPerColumn = 2;
					}else {
						ret.itemsPerColumn = 1;
					}
				}

				//Max width
				if(galleryWidth > 768){
				    ret.maxHeight = screen.height * 0.3;
				}else {
				    ret.maxHeight = screen.height;
				}
				return ret;
			}

			function resizeWidth(jChildren, rowWidth, margin){
				var currentWidth = _.reduce(jChildren, function(result, element){return result + element.width()}, 0);
				// -1 pixel to make the resize look smooth
				//Test adding 2px to the margin
				var factor =( rowWidth - 1 - (jChildren.length * (margin + 2) * 2)) / currentWidth;
			  	//var factor =( rowWidth - 1 - (jChildren.length * (margin) * 2)) / currentWidth;
			  	for (var i = 0; i < jChildren.length; i++) {

			  		jChildren[i].css('width',  jChildren[i].width() * factor);
				};
				return jChildren[0].height();
			}

			function resizeHeight(jChildren, childHeight){
				for (var i = 0; i < jChildren.length; i++) {
					var factor =  childHeight / jChildren[i].height();

					jChildren[i].width(jChildren[i].width() * factor);
				};
			}

			function renderRow(jChildren, galleryWidth, margin, maxHeight){
				//var rowHeight = _.min(jChildren, function(t){return t.height() }).height();
				var rowHeight = maxHeight;
				resizeHeight(jChildren, rowHeight);
				var rowHeight = resizeWidth(jChildren, galleryWidth, margin);	
				return rowHeight;
			}

			function renderLastRow(jChildren,  rowHeight){
				//Width can be wider than the screen!
				resizeHeight(jChildren, rowHeight);
				return rowHeight;
			}

			function renderGallery(jGallery, _params){
				var jChildren = []; //jquery childs
				var jChildRows = []; //jquery childs
				var dChildren = jGallery.children(); //dom childs
				var width = _params.width ? _params.width : jGallery.width();
				var screenSettings = getScreenSettings(width);
				imagesPerRow = _params.imagesPerRow ? _params.imagesPerRow : screenSettings.itemsPerColumn;
				_params.margin =_params.margin ? _params.margin : 3;
				var lastRowHeight;
				//This code looks a little too complex - seperate in multiple functions
				for (var i = 0; i < dChildren.length; i++) {
					var _jChild = $(dChildren[i]);
					if(_jChild.width() > 0){
						
						jChildren.push(_jChild);
						_jChild.css("margin", _params.margin);
						
						if(jChildren.length >= imagesPerRow || i == dChildren.length -1){
							var lastRow = i == dChildren.length -1;
							jChildRows.push(jChildren);
							if(!lastRow){
								lastRowHeight = renderRow(jChildRows[jChildRows.length - 1], width, _params.margin, screenSettings.maxHeight);	
							}else{
								 renderLastRow(jChildRows[jChildRows.length - 1], lastRowHeight);	
							}
							
							if(lastRowHeight < screenSettings.maxHeight){
								jChildren = [];
							}
						}
					}else{
						_jChild.load(function() {
							renderGallery(_this, params);
							$( this ).addClass( "imgloaded" );
						});

					}
				};
			}

			function init(){
				if(window.readyForGallerify){
					renderGallery(_this, params);
				}else{
					$(window).on("load", function() {
						renderGallery(_this, params);
					});
				}
				
				$( window ).resize(function() {
					renderGallery(_this, params);
				});	
			}
			init();
			return _this;
		};
	</script>
	<script type="text/javascript">
			$('.photos').gallerify({
				// margin:5,
				// width:300
			});	
	</script>
</body>
</html>