<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>JS Gallery</title>

	<!-- CSS -->
	<style type="text/css">
		body {
			text-align: center;
		}

		.photo {
			float: left;
			background-color: lightgray; 
		}

		.normal {
			width: 40px;
			height: 30px; 
		}

		.panorama {
			width: 160px;
			height: 90px; 
		}

		.portrait {
			width: 25px;
			height: 40px; 
		}

		.photos {
			width: 80%;
			margin:auto;
		}

	</style>
</head>
<body>
	<div class="photos">
		<div class="normal photo"></div>
		<div class="panorama photo"></div>
		<div class="normal photo"></div>
		<div class="normal photo"></div>
		<div class="portrait photo"></div>
		<div class="panorama photo"></div>
		<div class="normal photo"></div>
		<div class="normal photo"></div>
		<div class="portrait photo"></div>
		<div class="panorama photo"></div>
		<div class="panorama photo"></div>
		<div class="panorama photo"></div>
		<div class="normal photo"></div>
		<div class="normal photo"></div>
		<div class="normal photo"></div>
		<div class="portrait photo"></div>
		<div class="normal photo"></div>
		<div class="normal photo"></div>
		<div class="normal photo"></div>
	</div>

	<!-- Scripts -->
	<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
	<script type="text/javascript">
		$.fn.gallerify = function(params){
			params = params ? params : {};
			params.margin = params.margin ? params.margin : 5;
			currentJqueryObject = this;

			function resizeImageRow(rowWidth, imgObjs){

				var maxHeight = _.max(imgObjs, function(t){return t.height() }).height();
				for (var i = 0; i < imgObjs.length; i++) {
					var factor =  maxHeight / imgObjs[i].height();

					imgObjs[i].width(imgObjs[i].width() * factor);
					imgObjs[i].height(imgObjs[i].height() * factor);

				};

				var currentWidth = _.reduce(imgObjs, function(result, element){return result + element.width()}, 0);

				// -1 pixel to make the resize look smooth
				var factor =( rowWidth - 1 - (imgObjs.length * params.margin * 2)) / currentWidth;
				for (var i = 0; i < imgObjs.length; i++) {
					imgObjs[i].width(imgObjs[i].width() * factor);
					imgObjs[i].height(imgObjs[i].height() * factor);
				};
			}

			function resizeImages (){
				function getImages(_con){
					var imgs = [];
					var childs =  _con.children();
					for (var i = 0; i < childs.length; i++) {
						imgs.push($(childs[i]));
						$(childs[i]).css("margin", params.margin);
						if(imgs.length > 3){
							resizeImageRow(currentJqueryObject.width(), imgs)
							imgs = [];
						}
					};
					return imgs;
				}
				getImages(currentJqueryObject);
			}

			resizeImages();
			$( window ).resize(function() {
				resizeImages();
			});
			return this;
		};

		$('.photos').gallerify({
			margin:5
		});
	</script>
</body>
</html>